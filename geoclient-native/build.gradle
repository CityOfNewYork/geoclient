apply plugin: 'c'

model {
  platforms {
    linux_x64 {
       architecture "x86_64"
       operatingSystem "linux"
    }
    windows_x64 {
       architecture "x86_64"
       operatingSystem "windows"
    }
  }

  toolChains {
    gcc(Gcc) 
  }

  repositories {
    libs(PrebuiltLibraries) {
      geosupport {
        headers.srcDir gsIncludePath
        binaries.withType(SharedLibraryBinary) {
          if (targetPlatform.operatingSystem.windows) {
            // Visual C++ uses a .dll file with a different .lib file for linking 
            // (This does not apply to Cygwin or MinGW)
            sharedLibraryFile = file("${gsLibraryPath}/NYCgeo.dll")
            sharedLibraryLinkFile = file("${gsLibraryPath}/NYCgeo.lib")
          } else {
            sharedLibraryFile = file("${gsLibraryPath}/libgeo.so")
          }
        }
      }

      jni_jdk {
        binaries.withType(NativeBinary) {
          if (targetPlatform.operatingSystem.windows) {
            headers.srcDirs "${jniJavaHome}/include", "${jniJavaHome}/include/win32"
            binaries.withType(StaticLibraryBinary) {
              staticLibraryFile = file("${jniJavaHome}/lib/jvm.lib")
            }
          } else {
            headers.srcDirs "${jniJavaHome}/include", "${jniJavaHome}/include/linux"
          }
        }
      }
    }
  } // repositories

  binaries { modelMap ->
    withType(NativeLibraryBinarySpec) {
      if (toolChain in Gcc) {
        if (targetPlatform.operatingSystem.windows) {
          cCompiler.args "-o0", "-g3", "-Wall", "-std=c99"
          linker.args "-shared", "-L${gsLibraryPath}", "-Wl,--add-stdcall-alias", "-lm", "-lNYCgeo", "-lgeo", "-ledequiv", "-lapequiv", "-lsan", "-lsnd", "-lstExcpt", "-lStdLast", "-lStdUniv", "-lstEnder", "-lstretch", "-lthined"
        } else {
          cCompiler.args "-fPIC", "-o0", "-g3", "-Wall", "-std=c99"
          linker.args "-L${gsLibraryPath}", "-lc", "-lm", "-lgeo", "-ledequiv", "-lapequiv", "-lsan", "-lsnd", "-lstExcpt", "-lStdLast", "-lStdUniv", "-lstEnder", "-lstretch", "-lthined"
        }
      }
    }
    withType(NativeExecutableBinarySpec) {
      if (toolChain in Gcc) {
        cCompiler.args "-o0", "-g3", "-Wall", "-std=c99"
        if (targetPlatform.operatingSystem.windows) {
          linker.args "-L${gsLibraryPath}", "-Wl,--add-stdcall-alias", "-lm", "-lNYCgeo", "-lgeo", "-ledequiv", "-lapequiv", "-lsan", "-lsnd", "-lstExcpt", "-lStdLast", "-lStdUniv", "-lstEnder", "-lstretch", "-lthined"
        } else {
          linker.args "-L${gsLibraryPath}", "-lc", "-lm", "-lgeo", "-ledequiv", "-lapequiv", "-lsan", "-lsnd", "-lstExcpt", "-lStdLast", "-lStdUniv", "-lstEnder", "-lstretch", "-lthined"
        }
      }
    }
  }
} // model

model {
  components {
    geoclient(NativeLibrarySpec) {
      targetPlatform "linux_x64"
      targetPlatform "windows_x64"
      sources {
        c {
          source {
            srcDir "src/main/c"
            include "**/*.c"
          }
          exportedHeaders {
            srcDir "src/main/headers"
            include "**/*.h"
          }
          lib library: 'geosupport', linkage: 'api'
        }
      }
    }

    geoclientTest(NativeExecutableSpec) {
      targetPlatform "linux_x64"
      targetPlatform "windows_x64"
      baseName "geoclient_test"
      sources {
        c {
          source {
            srcDir "src/test/c"
            include "**/*.c"
          }
          exportedHeaders {
            srcDir "src/test/headers"
            include "**/*.h"
          }
          lib library: 'geosupport', linkage: 'api'
          lib library: 'geoclient', linkage: 'static'
        }
      }
    }

    geoclientJni(NativeLibrarySpec) {
      targetPlatform "linux_x64"
      targetPlatform "windows_x64"
      baseName "geoclient_jni"
      sources {
        c {
          source {
            srcDir "src/generated/c"
            include "**/*.c"
          }
          // Even though the generated JNI C code only depends on geoclient.h,
          // the Gluegen code generation process fails without this dependency
          // because Gluegen does not evaluate C macros. Since geoclient.h
          // includes geo.h (and NYCgeo.h on Windows) if these files are not on
          // the include path, Gluegen bails despite gluegen.cfg directives to
          // explicitly ignore libgeo API functions
          lib library: 'geosupport', linkage: 'api' // still needed by gluegen?
          lib library: 'jni_jdk', linkage: 'api'
          lib library: 'geoclient', linkage: 'static'
        }
      } // sources
    } // geoclient_jni
  } // components

  tasks {
    syncLocalNativeLibs(Sync) {
      description 'Sync native binaries to $localLibsDir for use by JNI integration tests.'
      def bins = $.binaries.withType(NativeLibraryBinarySpec).findAll { it.buildable }
      from bins.collect { it.primaryOutput }
      destinationDir = file(rootProject.localLibsDir)
    }
    build.finalizedBy(syncLocalNativeLibs)
  } // tasks 
} // model
