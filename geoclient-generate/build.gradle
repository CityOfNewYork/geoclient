import org.apache.tools.ant.filters.FixCrLfFilter
import org.apache.tools.ant.filters.ReplaceTokens

// TODO How to reference native subproject file/directory paths using
// component, sourceSet, etc. reference? 
// TODO Make me a Plugin! (*Poof*! You're a plugin!)

ext {
  adjustedComment =  '/* !---- DO NOT EDIT: This file autogenerated by Gluegen ----! */'
  generatedComment = '/* !---- DO NOT EDIT: This file autogenerated by '
  gluegenImport = 'import com.jogamp'
}

dependencies {
  compile(configurations.execGluegen)
}

processResources {
  description = 'Prepares the Gluegen config file'

  ext.javaOutputDir   = "$buildDir/generated/java"
  ext.nativeOutputDir = "$buildDir/generated/c"

  outputs.dir nativeOutputDir
  outputs.dir javaOutputDir

  expand(nativeOutputDir: nativeOutputDir, javaOutputDir: javaOutputDir)
  filter(FixCrLfFilter)
}

task generateSource (type: JavaExec, dependsOn: processResources) {
  description 'Generates *.java, *.c JNI files using Gluegen'

  ext.gluegenConfigFile = "$buildDir/resources/main/gluegen.cfg"
  ext.geoclientHeader = "${project(':geoclient-native').projectDir}/src/main/headers/geoclient.h"

  inputs.file gluegenConfigFile
  inputs.file geoclientHeader
  outputs.dir processResources.nativeOutputDir
  outputs.dir processResources.javaOutputDir

  classpath = files(configurations.runtime.files)
  main      = 'com.jogamp.gluegen.GlueGen'
  executable = "${jniJavaHome}/bin/java"
  // IMPORTANT: Gluegen's PCPP does not evaluate macros and geoclient.h
  // uses macros to include either NYCgeo.h or geo.h. If this task complains
  // complains about missing header files, make sure the platform include
  // directory contains both
  args "-I${gsIncludePath}"
  args '-Ecom.jogamp.gluegen.JavaEmitter'
  args "-C${gluegenConfigFile}"
  args "${geoclientHeader}"
  doFirst { logger.info "** Generating C and Java source files for JNI **" }
}

task refreshGeneratedNativeSource(type: Copy, dependsOn: generateSource) {
  description = 'Create/overwrite generated C source files in :geoclient-native'

  ext.targetNativeSourceDir = "${project(':geoclient-native').projectDir}/src/generated/c"
  ext.targetJavaSourceDir = "${project(':geoclient-jni').projectDir}/src/generated/java"

  inputs.dir  processResources.nativeOutputDir
  outputs.dir targetNativeSourceDir

  from(processResources.nativeOutputDir)
  into(targetNativeSourceDir)
  rename 'GeoclientImpl_JNI.c', 'geoclient_jni.c'
  
  // Filter timestamp
  filter { String line ->
    line.startsWith(generatedComment) ? adjustComment(line) : line
  }

}

task refreshGeneratedJavaSource(type: Copy, dependsOn: generateSource) {
  description = 'Create/overwrite generated Java source files in :geoclient-jni'

  inputs.dir  processResources.javaOutputDir
  outputs.dir refreshGeneratedNativeSource.targetJavaSourceDir

  from(processResources.javaOutputDir)
  into(refreshGeneratedNativeSource.targetJavaSourceDir)  
  // Comment out unused Java imports and remove timestamp
  eachFile { fileCopyDetails ->
    delegate.filter { String line ->
      if (line.startsWith(generatedComment)) {
        adjustComment(line)
      } else if(line.startsWith(gluegenImport)) {
        adjustImport(fileCopyDetails.name, line)
      } else {
        line
      }
    }
  }
}

task refreshGeneratedSource(dependsOn: ['refreshGeneratedJavaSource', 'refreshGeneratedNativeSource']) {
  description = 'Create/overwrite generated C and Java source files in other subprojects'

  outputs.files refreshGeneratedJavaSource.outputs.files, refreshGeneratedNativeSource.outputs.files
}

classes.dependsOn(refreshGeneratedSource)

task deleteGeneratedSource {
  doLast {
    logger.warn("Deleting all generated JNI Java and C source files: ${refreshGeneratedSource.outputs.files}")
    delete refreshGeneratedSource.outputs.files
  }
}

clean {
  doLast {
    logger.debug("Cowardly refusing to delete generated sources. Use 'deleteGeneratedSource' task instead.") 
  }
}

String adjustComment(String line) {
  adjustedComment
}

String adjustImport(String fileName, String line) {
    def result = line
    switch ( line ) {
      case 'import com.jogamp.gluegen.runtime.*;':
        result = '// import com.jogamp.gluegen.runtime.*;'
        break
      case 'import com.jogamp.common.os.*;':
        result = '// import com.jogamp.common.os.*;'
        break
      case { it == 'import com.jogamp.common.nio.*;' && fileName == 'Geoclient.java' }:
        result = '// import com.jogamp.common.nio.*;'
        break
      case 'import com.jogamp.common.nio.*;':
        result = 'import com.jogamp.common.nio.Buffers;'
        break
      default:
        result
    }
  result
}